% Copyright (c) 2013-19 Stephane GALLAND <galland@arakhne.org>
%
% UTBM logo and name are registered and owned by the
% "Universite de Technology of Belfort-Montbeliard".
%
% UB logo and name are registered and owned by the
% "Universite de Bourgogne".

% CIAD logo and name are registered and owned by the
% "Universite de Bourgogne Franche-Comt√©".
% 
% This program is free library; you can redistribute it and/or modify
% it under the terms of the GNU Lesser General Public License as
% published by the Free Software Foundation; either version 3 of the
% License, or any later version.
%
% This library is distributed in the hope that it will be useful, but
% WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% Lesser General Public License for more details.
%
% You should have received a copy of the GNU Lesser General Public
% License along with this library; see the file COPYING.  If not,
% write to the Free Software Foundation, Inc., 59 Temple Place - Suite
% 330, Boston, MA 02111-1307, USA.
%
\ProvidesPackage{beamerouterthemeCIAD}
   [2019/10/08 Beamer Outer 'CIAD' Theme]

\mode<presentation>

\useoutertheme{default}

\gdef\beamer@theme@ciad@outer@offsety{0}

\newlength\beamer@theme@ciad@outer@tmplength

\newlength\beamer@theme@ciad@outer@linewidth
\setlength\beamer@theme@ciad@outer@linewidth{\paperwidth}
\addtolength{\beamer@theme@ciad@outer@linewidth}{-2em}

\newlength\beamer@theme@ciad@outer@titlewidth
\setlength\beamer@theme@ciad@outer@titlewidth{\paperwidth}
\addtolength{\beamer@theme@ciad@outer@titlewidth}{-6.5em}

\newlength\beamer@theme@ciad@outer@titlewidth@plain
\setlength\beamer@theme@ciad@outer@titlewidth@plain{\textwidth}

\newlength\beamer@theme@ciad@outer@sideboxwidth
\setlength\beamer@theme@ciad@outer@sideboxwidth{6.8cm}

\newlength\beamer@theme@ciad@outer@topalignmentspan
\setlength\beamer@theme@ciad@outer@topalignmentspan{-.78cm}%-.82cm
\newlength\beamer@theme@ciad@outer@centeralignmentspan
\setlength\beamer@theme@ciad@outer@centeralignmentspan{-1ex}
\newlength\beamer@theme@ciad@outer@bottomalignmentspan
\setlength\beamer@theme@ciad@outer@bottomalignmentspan{0cm}

\gdef\beamer@theme@ciad@outer@valign{c}

\let\beamer@theme@ciad@outer@KV@beamerframe@t\KV@beamerframe@t
\define@key{beamerframe}{t}[true]{%
	\beamer@theme@ciad@outer@KV@beamerframe@t{#1}%
	\ifthenelse{\equal{#1}{true}}{%
		\gdef\beamer@theme@ciad@outer@valign{t}%
	}{}%
}

\let\beamer@theme@ciad@outer@KV@beamerframe@c\KV@beamerframe@c
\define@key{beamerframe}{c}[true]{%
	\beamer@theme@ciad@outer@KV@beamerframe@c{#1}%
	\ifthenelse{\equal{#1}{true}}{%
		\gdef\beamer@theme@ciad@outer@valign{c}%
	}{}%
}

\let\beamer@theme@ciad@outer@KV@beamerframe@b\KV@beamerframe@b
\define@key{beamerframe}{b}[true]{%
	\beamer@theme@ciad@outer@KV@beamerframe@b{#1}%
	\ifthenelse{\equal{#1}{true}}{%
		\gdef\beamer@theme@ciad@outer@valign{b}%
	}{}%
}

% See base definition for overriding this macro
\providecommand{\beamer@theme@ciad@outer@titlebackground}{}

% No navigation symbols
\setbeamertemplate{navigation symbols}{}

\newcommand{\beamer@theme@ciad@outer@background}{%
	\ifbeamer@theme@ciad@tableofcontentslide@background%
		\global\beamer@theme@ciad@tableofcontentslide@backgroundfalse%
		\begin{tikzpicture}%
		\path[shading = axis, rectangle, left color={top background in toc.bg}, right color={bottom background in toc.bg},shading angle=0, anchor=west](0,0) rectangle (0.15,-8.2);%
		\path[fill=CIADdarkgray](0,0) rectangle (13,0.95);%
		\path[fill=CIADgreen](0,0.095) rectangle (13,0);%
		\end{tikzpicture}%
	\else%
		\begin{tikzpicture}%
		\path[fill=CIADdarkgray](0,0) rectangle (13,0.95);%
		\path[fill=CIADgreen](0,0.095) rectangle (13,0);%
		\end{tikzpicture}%
	\fi
}

\setbeamertemplate{title page}{%
	\ifthenelse{\boolean{beamer@theme@ciad@fancytitlepage}}{%
		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		%%%% FANCY TITLE PAGE
		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		\expandafter\begin{picture}(0,0)(0,\beamer@theme@ciad@outer@offsety)%
		% Background
		\beamer@theme@ciad@outer@titlebackground
		% Text area
		\put(-20,-96){\usebeamercolor[fg]{maintitle}\parbox[c]{\beamer@theme@ciad@outer@linewidth}{%
			% Title and subtitle
			\nohyphens{\begin{center}\Large\textbf{\@beamer@theme@ciad@wraptextformats{\beamer@theme@ciad@conditionalfirsttailletters{\inserttitle}}}%
			\ifthenelse{\boolean{beamer@theme@ciad@eventintitlebar}}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{%
					\ifthenelse{\equal{a\inserteventname}{a}}{%
					}{%
						\\[.25em]\scriptsize\inserteventname%
					}%
				}{%
					\\[.25em]\scriptsize\insertsubtitle%
				}%
			}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{}{%
					\\[.25em]\scriptsize\insertsubtitle%
				}
			}%
			\\[.75em]%
			% Authors and event
			{\usebeamercolor[fg]{author}\small\bf\insertauthor}
			\ifthenelse{\boolean{beamer@theme@ciad@eventintitlebar}}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{}{%
					\ifthenelse{\equal{a\inserteventname}{a}}{{}}{\\[.1cm]\usebeamercolor[fg]{author}\scriptsize\inserteventname}%
				}%
			}{%
				\ifthenelse{\equal{a\inserteventname}{a}}{}{%
					\\\usebeamercolor[fg]{author}\scriptsize\inserteventname%
				}%
			}%
			\ifauthordescription%
				\\[.4cm]\usebeamercolor[fg]{author}\Tiny\insertauthordescription%
			\fi%
			\end{center}}}}%
		% Foot background
		\put(-28.45,-152.9){%
			\begin{tikzpicture}%
			\fill[CIADlightgray](0,0) rectangle (13,0.6);%
			\end{tikzpicture}%
		}
		% Institute
		\put(-20,-147){\tiny\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{flushleft}%
			{\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute}\end{flushleft}}}%
		% Partner logos
		\put(175,-149.2){\parbox[b]{5.4cm}{\mbox{}\hfill%
					\beamer@theme@ciad@partnerlogo%
					\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
						\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
					}{}%
					}}%
		\end{picture}%
	}{%
		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		%%%% OLD-SCHOOL TITLE PAGE
		%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		\expandafter\begin{picture}(0,0)(0,\beamer@theme@ciad@outer@offsety)%
		% Header
		\put(-28.4,93.25){%
			\beamer@theme@ciad@outer@background%
		}%
		\pgfmathsetmacro{\beamer@theme@ciad@titlepagetemplate@tmpa}{\beamer@theme@ciad@headerlineuserlogo@x - 28.5}%
		\pgfmathsetmacro{\beamer@theme@ciad@titlepagetemplate@tmpb}{\beamer@theme@ciad@headerlineuserlogo@y + 120.3}%
		\expandafter\put(\beamer@theme@ciad@titlepagetemplate@tmpa,\beamer@theme@ciad@titlepagetemplate@tmpb){%
			\beamer@theme@ciad@headline@currentpicture%
		}%
		% Title
		\put(-20,0){\usebeamercolor[fg]{maintitle}\parbox[c]{\beamer@theme@ciad@outer@linewidth}{%
			\nohyphens{\begin{center}\LARGE\textbf{\@beamer@theme@ciad@wraptextformats{\inserttitle}}%
			\ifthenelse{\boolean{beamer@theme@ciad@eventintitlebar}}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{%
					\ifthenelse{\equal{a\inserteventname}{a}}{%
					}{%
						\\[.5em]\footnotesize\inserteventname%
					}%
				}{%
					\\[.5em]\footnotesize\insertsubtitle%
				}%
			}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{}{%
					\\[.5em]\footnotesize\insertsubtitle%
				}
			}%
			\end{center}}}}%
		% Authors and event
		\put(-20,-80){\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{center}
			{\usebeamercolor[fg]{author}\large\bf\insertauthor}
			\ifthenelse{\boolean{beamer@theme@ciad@eventintitlebar}}{%
				\ifthenelse{\equal{a\insertsubtitle}{a}}{}{%
					\ifthenelse{\equal{a\inserteventname}{a}}{{}}{\\[.1cm]\usebeamercolor[fg]{author}\footnotesize\inserteventname}%
				}%
			}{%
				\ifthenelse{\equal{a\inserteventname}{a}}{}{%
					\\\usebeamercolor[fg]{author}\footnotesize\inserteventname%
				}%
			}%
			\ifauthordescription%
				\\[.4cm]\usebeamercolor[fg]{author}\tiny\insertauthordescription%
			\fi%
			\end{center}}}%
		% Foot background
		\put(-28.45,-152.9){%
			\begin{tikzpicture}%
			\fill[CIADlightgray](0,0) rectangle (13,0.6);%
			\end{tikzpicture}%
		}
		% Institute
		\put(-20,-147){\tiny\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{flushleft}%
			{\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute}\end{flushleft}}}%
		% Partner logos
		\put(175,-149.2){\parbox[b]{5.4cm}{\mbox{}\hfill%
					\beamer@theme@ciad@partnerlogo%
					\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
						\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
					}{}%
					}}%
		%
		\end{picture}%
	}%
}

\setbeamertemplate{frametitle}{%
		\ifbeamer@plainframe%
			\begin{picture}(0,40)(0,0)%
			% Header
			\put(-23,26){\usebeamercolor[fg]{plain frametitle}%
				\parbox[c]{\beamer@theme@ciad@outer@titlewidth@plain}{%
				\nohyphens{\begin{flushleft}\large\bf\@beamer@theme@ciad@wraptextformats{\insertframetitle}%
				\ifthenelse{\equal{a\insertframesubtitle}{a}}{{}}{%
					\usebeamercolor[fg]{plain framesubtitle}\small\bf~--~\@beamer@theme@ciad@wraptextformats{\insertframesubtitle}}%
				\end{flushleft}}%
			}}%
			\end{picture}%
		\else%
			\begin{picture}(0,40)(0,0)%
			% Header
			\ifbeamer@theme@ciad@headline@empty%
				\setlength{\beamer@theme@ciad@outer@tmplength}{\beamer@theme@ciad@outer@titlewidth}%
				\addtolength{\beamer@theme@ciad@outer@tmplength}{1cm}%
				\def\@tmp{-23}%
			\else%
				\setlength{\beamer@theme@ciad@outer@tmplength}{\beamer@theme@ciad@outer@titlewidth}%
				\def\@tmp{5}%
			\fi%
			\expandafter\put(\@tmp,26){\usebeamercolor[fg]{frametitle}%
				\parbox[c]{\beamer@theme@ciad@outer@tmplength}{%
				\nohyphens{\begin{flushleft}\normalsize\bf\@beamer@theme@ciad@wraptextformats{\setstretch{.75}\insertformattedframetitle}%
				\ifthenelse{\equal{a\insertframesubtitle}{a}}{{}}{%
					\usebeamercolor[fg]{framesubtitle}\small\bf~--~\@beamer@theme@ciad@wraptextformats{\insertframesubtitle}}%
				\end{flushleft}}%
			}}%
			% Side note
			\ifx\beamer@theme@ciad@sidenote\relax\else%
				\put(328,-210){\rotatebox{90}{\parbox[c]{\beamer@theme@ciad@outer@sideboxwidth}{%
						\usebeamerfont{sidenote}\usebeamercolor[fg]{sidenote}%
						\beamer@theme@ciad@sidenote%
				}}}%
				\global\let\beamer@theme@ciad@sidenote\relax%
			\fi%
			% Frame number
			\put(292,26){\parbox[c]{3em}{%
				{\mbox{}\hfill\usebeamercolor[fg]{frametitle}\tiny\insertframenumbering}%
			}}%
			% Partner logo
			\put(175,-230){\parbox[b]{5.4cm}{\mbox{}\hfill%
					\beamer@theme@ciad@partnerlogo%
					\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
						\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
					}{}%
					}}%
			% Put the background elements
			\beamer@theme@ciad@beginframe@hooks
			\end{picture}%
		\fi%
		% Change the space between the header and the body of the text.
		\mbox{}%
		\ifthenelse{\equal{=\beamer@theme@ciad@outer@valign}{=t}}{%
			\vspace{\beamer@theme@ciad@outer@topalignmentspan}%
		}{%
			\ifthenelse{\equal{=\beamer@theme@ciad@outer@valign}{=c}}{%
				\vspace{\beamer@theme@ciad@outer@centeralignmentspan}%
			}{%
				\vspace{\beamer@theme@ciad@outer@bottomalignmentspan}%
			}%
		}%
	}

\gdef\beamer@theme@ciad@outer@footline{%
	\ifbeamer@plainframe\else%
	\begin{picture}(0,25)(0,0)%
		% Foot background
		\put(0,0){%
			\begin{tikzpicture}%
			\fill[CIADlightgray](0,0) rectangle (13,0.6);%
			\end{tikzpicture}%
		}
		% Partner logos
		\put(203.45,3.5){\parbox[b]{5.4cm}{\mbox{}\hfill%
					\beamer@theme@ciad@partnerlogo%
					\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
						\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
					}{}%
					}}%
		% Left text
		\beamer@theme@ciad@footline@default%
	\end{picture}%
	\fi%
}

\setbeamertemplate{part page}{%
		\begin{picture}(0,0)(0,0)%
		% Foot background
		\put(-28.45,-167.5){%-172.9
			\begin{tikzpicture}%
			\fill[CIADlightgray](0,0) rectangle (13,0.6);%
			\end{tikzpicture}%
		}
		% Institute
		\put(-20,-161.6){\tiny\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{flushleft}%
			{\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute}\end{flushleft}}}%
		% Partner logos -166.8
		\put(175,-163.8){\parbox[b]{5.4cm}{\mbox{}\hfill%
					\beamer@theme@ciad@partnerlogo%
					\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
						\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
					}{}%
					}}%
		% Title
		\put(-20,-39){\usebeamercolor[fg]{maintitle}\parbox[c]{\beamer@theme@ciad@outer@linewidth}{%
			\nohyphens{\begin{center}\LARGE\textbf{\@beamer@theme@ciad@wraptextformats{{\insertpartprefix}\beamer@partname}}%
		\end{center}}}}%
		% Author
		\ifbeamer@theme@ciad@part@hasauthor%
		\put(-20,-95){\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{center}
			{\usebeamercolor[fg]{author}\large\bf\beamer@theme@ciad@part@theauthor}
			\end{center}}}%
		\fi%
		\end{picture}%
}

\newcommand{\thanksslide}{%
	\setbeamertemplate{footline}{}
	\usebackgroundtemplate{\beamer@theme@ciad@outer@background}%
	\frame{
		% Copy of the title page
		\ifthenelse{\value{@beamer@theme@ciad@finalslidelabel}=3}{%
			\gdef\beamer@theme@ciad@outer@offsety{14.4}%
			\usebeamertemplate{title page}%
			\gdef\beamer@theme@ciad@outer@offsety{0}%
		}{%
			\ifcase\value{@beamer@theme@ciad@finalslidelabel}%
				\def\beamer@theme@ciad@outer@thanks@tmp{\translate{Thanks}}%
			\or%
				\def\beamer@theme@ciad@outer@thanks@tmp{\translate{Questions}}%
			\or%
				\def\beamer@theme@ciad@outer@thanks@tmp{%
					\beamer@theme@ciad@conditionalfirsttailletters\beamer@theme@ciad@label@finalslidelabel%
				}
			\else%
				\def\beamer@theme@ciad@outer@thanks@tmp{}%
				\errmessage{Package Beamer/CIAD: Unsupported type of message for the final slide.}%
			\fi%
			\begin{picture}(0,10)(0,0)%
				% Message
				\put(-20,-38.5){\usebeamercolor[fg]{maintitle}\parbox[c]{\beamer@theme@ciad@outer@linewidth}{%
					\nohyphens{\begin{center}\LARGE\textbf{%
						\beamer@theme@ciad@outer@thanks@tmp%
					}\end{center}}}}%
					% Foot background

					\put(-28.45,-167.5){%-172.9
						\begin{tikzpicture}%
						\fill[CIADlightgray](0,0) rectangle (13,0.6);%
						\end{tikzpicture}%
					}
					% Institute
					\put(-20,-161.6){\tiny\parbox[c]{\beamer@theme@ciad@outer@linewidth}{\begin{flushleft}%
						{\usebeamerfont{institute}\usebeamercolor[fg]{institute}\insertinstitute}\end{flushleft}}}%
					% Partner logos
					\put(175,-163.8){\parbox[b]{5.4cm}{\mbox{}\hfill%
								\beamer@theme@ciad@partnerlogo%
								\ifthenelse{\boolean{beamer@theme@ciad@lablogo}}{%
									\hspace{.1cm}\insertinstitutelogosinfootline{\hspace{.1cm}}%
								}{}%
								}}%
			\end{picture}%
		}%
	}%
	\usebackgroundtemplate{\ifbeamer@plainframe\else\beamer@theme@ciad@outer@background\fi}%
	\setbeamertemplate{footline}{\beamer@theme@ciad@outer@footline}%
}

\newcommand{\beamer@theme@ciad@outer@thanksslide}{%
	\beamer@theme@ciad@nav@advancesection%
	\xdef\beamer@theme@ciad@totalcoreframenumber{\the\c@framenumber}
	\addtocounter{section}{1}% To be sure that the 'thank' slide is not in the same section as the previous slide.
	\thanksslide%
}

\setbeamertemplate{frametitle continuation}{%
	{\smaller(\#\insertcontinuationcount)}%
}

\mode
<all>
